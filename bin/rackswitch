 #!/usr/bin/env bash

 echo -e "RackMan Version Switch Script"
 if [ $# -lt 2 ]; then
 	echo "$0 DEPLOY VERSION [STATIC]"
 	echo "Switches the current deployment located at DEPLOY to a specific VERSION, and sets .rackversion to VERSION"
 	echo ""
 	echo " DEPLOY - The directory containing the application's deployments and the .rackversion file"
 	echo " VERSION - The version of the application you are deploying, used to generate the target folder and new .rackversion"
 	echo " STATIC - Optional static resource folder, will be symlinked to DEPLOY/STATIC for serving by your web server"
 	exit 1
 fi

SOURCE=$(pwd)
DEPLOY=$(readlink -e $1)
VERSION=$2
STATIC=$3

function success() {
	echo "DONE"
}

function error() {
	echo "FAILED"
	exit 1
}

TARGET=$DEPLOY/$VERSION

if [ ! -d "$TARGET" ]; then
	echo "Target version could not be found" &1>2
	exit 1
fi

echo -e "Bumping .rackversion..."
echo "$VERSION" > "$DEPLOY/.rackversion" && success || error

if [[ "$STATIC" != "" ]]; then
	echo -e "Linking Static Files..."
	ln -sfT "$TARGET/$STATIC" "$DEPLOY/$STATIC" && success || error
fi